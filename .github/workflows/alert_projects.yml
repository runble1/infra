name: Code Scanning to Projects

on:
  #  code_scanning_alert:
  #    types:
  #      - appeared
  #      - fixed
  #      - closed
  workflow_run:
    workflows: ["Code Scanning"]
    types:
      - completed
  workflow_dispatch:

jobs:
  alert_handling:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Handle Code Scanning Alerts
        uses: actions/github-script@v6
        with:
          script: |
            // Code Scanning アラートを取得する
            const alerts = await github.rest.codeScanning.listAlertsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            // 既存の問題を検索
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "all",
              labels: ["code scanning"],
              creator: context.repo.owner,
            });

            for (const alert of alerts.data) {
              const issueTitle = `Code Scanning Alert: ${alert.rule.name}`;
              const issueBody = `Please handle the following code scanning alert:\n\n- [ ] ${alert.rule.description} (${alert.html_url})`;

              const existingIssue = issues.data.find(issue => issue.title === issueTitle);

              if (alert.state === "open") {
                if (existingIssue) {
                  // 既存の問題を更新
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: existingIssue.number,
                    body: issueBody,
                  });
                } else {
                  // 新しい問題を作成
                  await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: issueTitle,
                    body: issueBody,
                    labels: ["code scanning"],
                  });
                }
              } else if (alert.state === "fixed" || alert.state === "dismissed") {
                if (existingIssue) {
                  // 既存の問題を閉じる
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: existingIssue.number,
                    state: "closed",
                  });
                }
              }
            }

      - name: Post to a Slack channel
        id: slack
        uses: slackapi/slack-github-action@v1.23.0
        with:
          channel-id: ${{ secrets.TF_VAR_SLACK_CHANNEL_ID }}
          payload: |
            {
              "text": "GitHub Action build result: ${{ job.status }}\n${{ github.event.pull_request.html_url || github.event.head_commit.url }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "GitHub Action build result: ${{ job.status }}\n${{ github.event.pull_request.html_url || github.event.head_commit.url }}"
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
